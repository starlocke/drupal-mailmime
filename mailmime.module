<?php

/**
 * @file
 * Ensures that required files are available.
 */

/**
 * Implements hook_init().
 *
 * Ensures that required PEAR modules are available, or else disables the
 * Mail MIME module to avoid conflicts.
 */
function mailmime_init() {
  // This only needs to succeed once.
  if (cache_get('mailmime_installed', 'cache_bootstrap')) {
    return;
  }
  if (mailmime_check_requirements()) {
    cache_set('mailmime_installed', TRUE, 'cache_menu');
    return;
  }
  // Requirements check failed; disable module and issue an error message.
  module_disable(array('mailmime'));
  $args = array(
    '!include' => url('http://drupal.org/project/include'),
    '!include_path' => url('http://php.net/set_include_path'),
    '!module' => url('http://drupal.org/project/mailmime'),
    '!modules' => url('admin/build/modules'),
    '!package' => url('http://pear.php.net/package/Mail_Mime'),
    '!pear' => url('http://pear.php.net'),
  );
  drupal_set_message(
    t('The required <a href="!pear">PEAR</a> package <a href="!package">Mail_Mime</a> could not be found. The <a href="!module">Mail MIME</a> module has been disabled to avoid further errors. Please download and install the <a href="!package">Mail_Mime</a> package, then then visit your <a href="!modules">Modules</a> page to re-enable the <a href="!module">Mail MIME</a> module.',
      $args), 'error'
  );
  if (module_exists('include')) {
    drupal_set_message(
      t('The <a href="!include">Include</a> module tried to automatically download the required files, but the attempt failed. You may retry the download by re-enabling the <a href="!module">Mail MIME</a> module.  If your hosting provider has disabled the <a href="!include_path"><code>set_include_path</code></a> directive, the files must be manually installed.',
        $args), 'error'
    );
  }
  else {
    drupal_set_message(
      t('If installed, the <a href="!include">Include</a> module can attempt to automatically download the required files for you.',
        $args), 'status'
    );
  }
  watchdog('mailmime',
    'The <a href="!module">Mail MIME</a> module has disabled itself.',
    $args, WATCHDOG_CRITICAL
  );
}

/**
 * Checks whether required files exist.
 */
function mailmime_check_requirements() {
  // Try including the files, then cleck for the classes.
  @include_once('Mail/mime.php');
  @include_once('Mail/mimeDecode.php');
  @include_once('Mail/mimePart.php');
  if ( class_exists('Mail_Mime')
    && class_exists('Mail_mimeDecode')
    && class_exists('Mail_mimePart')
  ) {
    return TRUE;
  }
  // One or more classes don't exist.  Try downloading them.
  if (module_exists('include')) {
    return mailmime_download_requirements();
  }
  return FALSE;
}

/**
 * Attempts to use the Include module to download required files.
 */
function mailmime_download_requirements() {
  $svn = 'http://svn.php.net/repository/pear/';
  $packages = array(
    'Mail_mime' => array(
      'local_path' => 'Mail/',
      'remote_path' => 'packages/Mail_Mime/trunk/',
      'files' => array(
        'mime.php',
        'mimeDecode.php',
        'mimePart.php',
      ),
    ),
    'PEAR' => array(
      'local_path' => '',
      'remote_path' => 'pear-core/trunk/',
      'files' => array(
        'PEAR.php',
        'PEAR5.php',
      ),
    ),
  );
  foreach ($packages as $name => $package) {
    $dst = $package['local_path'];
    $src = $package['remote_path'];
    foreach ($package['files'] as $file) {
      if (!include_check_path("$dst$file", "$svn$src$file", 'url')) {
        return FALSE;
      }
    }
  }
  return TRUE;
}
